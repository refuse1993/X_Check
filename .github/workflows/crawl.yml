name: X Threat Intelligence Crawler

on:
  schedule:
    - cron: '0 * * * *'  # λ§¤μ‹κ°„ μ •κ°
  push:
    paths:
      - 'config.json'    # μ„¤μ • νμΌ λ³€κ²½ μ‹ μ¦‰μ‹ μ‹¤ν–‰
  workflow_dispatch:      # μλ™ μ‹¤ν–‰

permissions:
  contents: write
  issues: write

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: Load config
        id: config
        run: |
          echo "SEARCH_MODE=$(jq -r '.search_mode' config.json)" >> $GITHUB_OUTPUT
          echo "TARGETS=$(jq -r '.targets | join(",")' config.json)" >> $GITHUB_OUTPUT
          echo "MAX_TWEETS=$(jq -r '.max_tweets' config.json)" >> $GITHUB_OUTPUT
          echo "CREATE_ISSUE=$(jq -r '.create_issue' config.json)" >> $GITHUB_OUTPUT
          echo "ISSUE_THRESHOLD=$(jq -r '.issue_threshold' config.json)" >> $GITHUB_OUTPUT

      - name: Run crawler
        env:
          SEARCH_MODE: ${{ steps.config.outputs.SEARCH_MODE }}
          TARGET_ACCOUNTS: ${{ steps.config.outputs.TARGETS }}
          MAX_TWEETS: ${{ steps.config.outputs.MAX_TWEETS }}
        run: python x_crawler.py --once

      - name: Commit results
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ logs/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "π¤– λ°μ΄ν„° μμ§‘: $(date +'%Y-%m-%d %H:%M KST')"
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Analyze and notify
        if: steps.commit.outputs.has_changes == 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MATTERMOST_WEBHOOK: ${{ secrets.MATTERMOST_WEBHOOK }}
          THRESHOLD: ${{ steps.config.outputs.ISSUE_THRESHOLD }}
          CREATE_ISSUE: ${{ steps.config.outputs.CREATE_ISSUE }}
        run: |
          # μµμ‹  μμ§‘ νμΌλ“¤ λ¶„μ„
          TOTAL_TWEETS=0
          REPORT_TEXT=""

          for dir in data/*/; do
            LATEST=$(ls -t "${dir}"*.json 2>/dev/null | head -1)
            if [ -n "$LATEST" ]; then
              KEYWORD=$(basename "$dir")
              COUNT=$(jq '.tweets | length' "$LATEST" 2>/dev/null || echo 0)

              if [ "$COUNT" -gt 0 ]; then
                TOTAL_TWEETS=$((TOTAL_TWEETS + COUNT))
                REPORT_TEXT="${REPORT_TEXT}### ${KEYWORD} (${COUNT}κ±΄)\n"

                # μƒμ„ 3κ° νΈμ— μ”μ•½
                TWEETS=$(jq -r '.tweets[:3][] | "- @\(.user.username): \(.text[:80] | gsub("\n"; " ") | gsub("\""; ""))"' "$LATEST" 2>/dev/null || echo "")
                REPORT_TEXT="${REPORT_TEXT}${TWEETS}\n\n"
              fi
            fi
          done

          echo "μ΄ μμ§‘: ${TOTAL_TWEETS}κ±΄"

          # Issue μƒμ„±
          if [ "$CREATE_ISSUE" == "true" ] && [ "$TOTAL_TWEETS" -ge "$THRESHOLD" ]; then
            BODY=$(printf "## π¨ μ„ν‘ μΈν…”λ¦¬μ „μ¤ μμ§‘ κ²°κ³Ό\n\n**μμ§‘ μ‹κ°„**: $(date +'%Y-%m-%d %H:%M KST')\n**μ΄ νΈμ—**: ${TOTAL_TWEETS}κ±΄\n\n${REPORT_TEXT}\n---\n_μλ™ μƒμ„±λ λ¦¬ν¬νΈμ…λ‹λ‹¤._")

            gh issue create \
              --title "π¨ μ„ν‘ κ°μ§€ λ¦¬ν¬νΈ: $(date +'%Y-%m-%d %H:%M')" \
              --body "$BODY" \
              --label "threat-intel,automated" || echo "Issue μƒμ„± μ‹¤ν¨"
          fi

          # Mattermost μ•λ¦Ό
          if [ -n "$MATTERMOST_WEBHOOK" ] && [ "$TOTAL_TWEETS" -gt 0 ]; then
            # JSON μ•μ „ν•κ² μƒμ„±
            SAFE_TEXT=$(printf "### π¨ μ„ν‘ μΈν…”λ¦¬μ „μ¤ μ•λ¦Ό\n\n**μμ§‘ μ‹κ°„**: $(date +'%%Y-%%m-%%d %%H:%%M KST')\n**μ΄ νΈμ—**: ${TOTAL_TWEETS}κ±΄\n\n${REPORT_TEXT}[GitHubμ—μ„ λ³΄κΈ°](https://github.com/${{ github.repository }})" | sed 's/"/\\"/g')

            curl -sS -X POST \
              -H 'Content-Type: application/json' \
              --connect-timeout 10 \
              --max-time 30 \
              -d "{\"text\": \"${SAFE_TEXT}\"}" \
              "$MATTERMOST_WEBHOOK" && echo "Mattermost μ•λ¦Ό μ „μ†΅ μ™„λ£" || echo "Mattermost μ•λ¦Ό μ‹¤ν¨"
          fi
