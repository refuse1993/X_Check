name: X Threat Intelligence Crawler

on:
  schedule:
    - cron: '0 * * * *'  # ë§¤ì‹œê°„ ì •ê°
  push:
    paths:
      - 'config.json'    # ì„¤ì • íŒŒì¼ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰

permissions:
  contents: write
  issues: write

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: Load config
        id: config
        run: |
          echo "SEARCH_MODE=$(jq -r '.search_mode' config.json)" >> $GITHUB_OUTPUT
          echo "TARGETS=$(jq -r '.targets | join(",")' config.json)" >> $GITHUB_OUTPUT
          echo "MAX_TWEETS=$(jq -r '.max_tweets' config.json)" >> $GITHUB_OUTPUT
          echo "CREATE_ISSUE=$(jq -r '.create_issue' config.json)" >> $GITHUB_OUTPUT
          echo "ISSUE_THRESHOLD=$(jq -r '.issue_threshold' config.json)" >> $GITHUB_OUTPUT

      - name: Run crawler
        env:
          SEARCH_MODE: ${{ steps.config.outputs.SEARCH_MODE }}
          TARGET_ACCOUNTS: ${{ steps.config.outputs.TARGETS }}
          MAX_TWEETS: ${{ steps.config.outputs.MAX_TWEETS }}
        run: python x_crawler.py --once

      - name: Commit results
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ logs/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "ğŸ¤– ë°ì´í„° ìˆ˜ì§‘: $(date +'%Y-%m-%d %H:%M KST')"
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Analyze and notify
        if: steps.commit.outputs.has_changes == 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MATTERMOST_WEBHOOK: ${{ secrets.MATTERMOST_WEBHOOK }}
          THRESHOLD: ${{ steps.config.outputs.ISSUE_THRESHOLD }}
          CREATE_ISSUE: ${{ steps.config.outputs.CREATE_ISSUE }}
          TARGETS: ${{ steps.config.outputs.TARGETS }}
        run: |
          # config.jsonì˜ íƒ€ê²Ÿë§Œ ë¶„ì„
          TOTAL_TWEETS=0
          REPORT_TEXT=""
          TABLE_ROWS=""

          IFS=',' read -ra TARGET_ARRAY <<< "$TARGETS"

          for KEYWORD in "${TARGET_ARRAY[@]}"; do
            DIR="data/${KEYWORD}"
            if [ -d "$DIR" ]; then
              LATEST=$(ls -t "${DIR}"/*.json 2>/dev/null | head -1)
              if [ -n "$LATEST" ]; then
                COUNT=$(jq '.tweets | length' "$LATEST" 2>/dev/null || echo 0)

                if [ "$COUNT" -gt 0 ]; then
                  TOTAL_TWEETS=$((TOTAL_TWEETS + COUNT))
                  TABLE_ROWS="${TABLE_ROWS}| ğŸ” **${KEYWORD}** | ${COUNT}ê±´ |\n"

                  REPORT_TEXT="${REPORT_TEXT}<details>\n<summary>ğŸ” <b>${KEYWORD}</b> (${COUNT}ê±´)</summary>\n\n"

                  # ìƒìœ„ 5ê°œ íŠ¸ìœ—
                  TWEETS=$(jq -r '.tweets[:5][] | "| @\(.user.username) | \(.text[:100] | gsub("\n"; " ") | gsub("\\|"; "/")) |"' "$LATEST" 2>/dev/null || echo "")
                  REPORT_TEXT="${REPORT_TEXT}| ê³„ì • | ë‚´ìš© |\n|------|------|\n${TWEETS}\n\n</details>\n\n"
                fi
              fi
            fi
          done

          echo "ì´ ìˆ˜ì§‘: ${TOTAL_TWEETS}ê±´"

          # Issue ìƒì„±
          if [ "$CREATE_ISSUE" == "true" ] && [ "$TOTAL_TWEETS" -ge "$THRESHOLD" ]; then
            BODY=$(cat <<EOF
          ## ğŸš¨ X ìœ„í˜‘ ì¸í…”ë¦¬ì „ìŠ¤ ë¦¬í¬íŠ¸

          | í•­ëª© | ê°’ |
          |------|-----|
          | ğŸ“… ìˆ˜ì§‘ ì‹œê°„ | $(date +'%Y-%m-%d %H:%M KST') |
          | ğŸ“Š ì´ íŠ¸ìœ— | **${TOTAL_TWEETS}ê±´** |
          | ğŸ¯ ëª¨ë‹ˆí„°ë§ í‚¤ì›Œë“œ | ${TARGETS} |

          ---

          ## ğŸ“‹ í‚¤ì›Œë“œë³„ ìš”ì•½

          | í‚¤ì›Œë“œ | ìˆ˜ì§‘ëŸ‰ |
          |--------|--------|
          $(printf "${TABLE_ROWS}")

          ---

          ## ğŸ“ ìƒì„¸ ë‚´ìš©

          $(printf "${REPORT_TEXT}")

          ---
          > ğŸ¤– _ìë™ ìƒì„±ëœ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤._ | [Actions ë¡œê·¸](https://github.com/${{ github.repository }}/actions)
          EOF
          )

            gh issue create \
              --title "ğŸš¨ [$(date +'%m/%d %H:%M')] ìœ„í˜‘ ê°ì§€: ${TOTAL_TWEETS}ê±´" \
              --body "$BODY" \
              --label "threat-intel,automated" || echo "Issue ìƒì„± ì‹¤íŒ¨"
          fi

          # Mattermost ì•Œë¦¼
          if [ -n "$MATTERMOST_WEBHOOK" ] && [ "$TOTAL_TWEETS" -gt 0 ]; then
            MM_TEXT="### ğŸš¨ X ìœ„í˜‘ ì¸í…”ë¦¬ì „ìŠ¤ ì•Œë¦¼\n\n"
            MM_TEXT="${MM_TEXT}| í•­ëª© | ê°’ |\n|------|-----|\n"
            MM_TEXT="${MM_TEXT}| ìˆ˜ì§‘ ì‹œê°„ | $(date +'%Y-%m-%d %H:%M KST') |\n"
            MM_TEXT="${MM_TEXT}| ì´ íŠ¸ìœ— | **${TOTAL_TWEETS}ê±´** |\n\n"
            MM_TEXT="${MM_TEXT}#### í‚¤ì›Œë“œë³„ í˜„í™©\n${TABLE_ROWS}\n"
            MM_TEXT="${MM_TEXT}[GitHubì—ì„œ ìƒì„¸ ë³´ê¸°](https://github.com/${{ github.repository }}/issues)"

            SAFE_TEXT=$(printf "$MM_TEXT" | sed 's/"/\\"/g')

            curl -sS -X POST \
              -H 'Content-Type: application/json' \
              --connect-timeout 10 \
              --max-time 30 \
              -d "{\"text\": \"${SAFE_TEXT}\"}" \
              "$MATTERMOST_WEBHOOK" && echo "Mattermost ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ" || echo "Mattermost ì•Œë¦¼ ì‹¤íŒ¨"
          fi
