name: X Threat Intelligence Crawler

on:
  schedule:
    - cron: '0 * * * *'  # ë§¤ì‹œê°„ ì •ê°
  push:
    paths:
      - 'config.json'    # ì„¤ì • íŒŒì¼ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰

permissions:
  contents: write
  issues: write

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: Load config
        id: config
        run: |
          echo "SEARCH_MODE=$(jq -r '.search_mode' config.json)" >> $GITHUB_OUTPUT
          echo "TARGETS=$(jq -r '.targets | join(",")' config.json)" >> $GITHUB_OUTPUT
          echo "MAX_TWEETS=$(jq -r '.max_tweets' config.json)" >> $GITHUB_OUTPUT
          echo "CREATE_ISSUE=$(jq -r '.create_issue' config.json)" >> $GITHUB_OUTPUT
          echo "ISSUE_THRESHOLD=$(jq -r '.issue_threshold' config.json)" >> $GITHUB_OUTPUT

      - name: Run crawler
        env:
          SEARCH_MODE: ${{ steps.config.outputs.SEARCH_MODE }}
          TARGET_ACCOUNTS: ${{ steps.config.outputs.TARGETS }}
          MAX_TWEETS: ${{ steps.config.outputs.MAX_TWEETS }}
        run: python x_crawler.py --once

      - name: Commit results
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ logs/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "ğŸ¤– ë°ì´í„° ìˆ˜ì§‘: $(date +'%Y-%m-%d %H:%M KST')"
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Analyze and create issue
        if: steps.config.outputs.CREATE_ISSUE == 'true' && steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          THRESHOLD: ${{ steps.config.outputs.ISSUE_THRESHOLD }}
        run: |
          # ìµœì‹  ìˆ˜ì§‘ íŒŒì¼ë“¤ ë¶„ì„
          TOTAL_TWEETS=0
          SUMMARY=""

          for dir in data/*/; do
            LATEST=$(ls -t "${dir}"*.json 2>/dev/null | head -1)
            if [ -n "$LATEST" ]; then
              KEYWORD=$(basename "$dir")
              COUNT=$(jq '.tweets | length' "$LATEST" 2>/dev/null || echo 0)
              TOTAL_TWEETS=$((TOTAL_TWEETS + COUNT))

              if [ "$COUNT" -gt 0 ]; then
                SUMMARY="${SUMMARY}\n### ğŸ” ${KEYWORD} (${COUNT}ê±´)\n"
                SUMMARY="${SUMMARY}$(jq -r '.tweets[:3][] | "- **@\(.user.username)**: \(.text[:120] | gsub("\n"; " "))..."' "$LATEST" 2>/dev/null || echo "")\n"
              fi
            fi
          done

          # ì„ê³„ê°’ ì´ìƒì´ë©´ Issue ìƒì„±
          if [ "$TOTAL_TWEETS" -ge "$THRESHOLD" ]; then
            BODY=$(printf "## ğŸš¨ ìœ„í˜‘ ì¸í…”ë¦¬ì „ìŠ¤ ìˆ˜ì§‘ ê²°ê³¼\n\n**ìˆ˜ì§‘ ì‹œê°„**: $(date +'%Y-%m-%d %H:%M KST')\n**ì´ íŠ¸ìœ—**: ${TOTAL_TWEETS}ê±´\n\n${SUMMARY}\n\n---\n_ìë™ ìƒì„±ëœ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤._")

            gh issue create \
              --title "ğŸš¨ ìœ„í˜‘ ê°ì§€ ë¦¬í¬íŠ¸: $(date +'%Y-%m-%d %H:%M')" \
              --body "$BODY" \
              --label "threat-intel,automated"
          fi

          # ê²°ê³¼ ì €ì¥ (Mattermost ì•Œë¦¼ìš©)
          echo "$TOTAL_TWEETS" > /tmp/total_tweets
          printf "$SUMMARY" > /tmp/summary

      - name: Send Mattermost notification
        if: steps.commit.outputs.has_changes == 'true'
        env:
          MATTERMOST_WEBHOOK: ${{ secrets.MATTERMOST_WEBHOOK }}
        run: |
          if [ -z "$MATTERMOST_WEBHOOK" ]; then
            echo "MATTERMOST_WEBHOOK not set, skipping notification"
            exit 0
          fi

          TOTAL_TWEETS=$(cat /tmp/total_tweets 2>/dev/null || echo "0")
          SUMMARY=$(cat /tmp/summary 2>/dev/null || echo "")

          # Mattermost ë©”ì‹œì§€ í¬ë§·
          MESSAGE=$(cat <<EOF
          {
            "username": "X Threat Bot",
            "icon_emoji": ":warning:",
            "text": "### ğŸš¨ ìœ„í˜‘ ì¸í…”ë¦¬ì „ìŠ¤ ì•Œë¦¼\n\n**ìˆ˜ì§‘ ì‹œê°„**: $(date +'%Y-%m-%d %H:%M KST')\n**ì´ íŠ¸ìœ—**: ${TOTAL_TWEETS}ê±´\n${SUMMARY}\n\n[GitHubì—ì„œ ë³´ê¸°](https://github.com/${{ github.repository }})"
          }
          EOF
          )

          curl -X POST -H 'Content-Type: application/json' \
            -d "$MESSAGE" \
            "$MATTERMOST_WEBHOOK"
