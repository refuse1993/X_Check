name: X Threat Intelligence Crawler

on:
  schedule:
    - cron: '0 */2 * * *'  # 2ÏãúÍ∞ÑÎßàÎã§
  push:
    paths:
      - 'config.json'    # ÏÑ§Ï†ï ÌååÏùº Î≥ÄÍ≤Ω Ïãú Ï¶âÏãú Ïã§Ìñâ
  workflow_dispatch:      # ÏàòÎèô Ïã§Ìñâ

permissions:
  contents: write
  issues: write

concurrency:
  group: crawler
  cancel-in-progress: true

jobs:
  crawl:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: Load config
        id: config
        run: |
          echo "SEARCH_MODE=$(jq -r '.search_mode' config.json)" >> $GITHUB_OUTPUT
          echo "TARGETS=$(jq -r '.targets | join(",")' config.json)" >> $GITHUB_OUTPUT
          echo "MAX_TWEETS=$(jq -r '.max_tweets' config.json)" >> $GITHUB_OUTPUT
          echo "CREATE_ISSUE=$(jq -r '.create_issue' config.json)" >> $GITHUB_OUTPUT
          echo "ISSUE_THRESHOLD=$(jq -r '.issue_threshold' config.json)" >> $GITHUB_OUTPUT

      - name: Run crawler
        env:
          SEARCH_MODE: ${{ steps.config.outputs.SEARCH_MODE }}
          TARGET_ACCOUNTS: ${{ steps.config.outputs.TARGETS }}
          MAX_TWEETS: ${{ steps.config.outputs.MAX_TWEETS }}
        run: python x_crawler.py --once

      - name: Commit results
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ logs/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "ü§ñ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë: $(date +'%Y-%m-%d %H:%M KST')"
            git pull --rebase || true
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Analyze and notify
        if: steps.commit.outputs.has_changes == 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          THRESHOLD: ${{ steps.config.outputs.ISSUE_THRESHOLD }}
          CREATE_ISSUE: ${{ steps.config.outputs.CREATE_ISSUE }}
          TARGETS: ${{ steps.config.outputs.TARGETS }}
        run: |
          # config.jsonÏùò ÌÉÄÍ≤üÎßå Î∂ÑÏÑù
          TOTAL_TWEETS=0
          REPORT_TEXT=""
          TABLE_ROWS=""

          IFS=',' read -ra TARGET_ARRAY <<< "$TARGETS"

          for KEYWORD in "${TARGET_ARRAY[@]}"; do
            DIR="data/${KEYWORD}"
            if [ -d "$DIR" ]; then
              LATEST=$(ls -t "${DIR}"/*.json 2>/dev/null | head -1)
              if [ -n "$LATEST" ]; then
                COUNT=$(jq '.tweets | length' "$LATEST" 2>/dev/null || echo 0)

                if [ "$COUNT" -gt 0 ]; then
                  TOTAL_TWEETS=$((TOTAL_TWEETS + COUNT))
                  TABLE_ROWS="${TABLE_ROWS}| üîç **${KEYWORD}** | ${COUNT}Í±¥ |\n"

                  REPORT_TEXT="${REPORT_TEXT}## üîç ${KEYWORD} (${COUNT}Í±¥)\n\n"

                  # Î™®Îì† Ìä∏Ïúó ÏÉÅÏÑ∏ Ï†ïÎ≥¥
                  while IFS= read -r tweet_json; do
                    USERNAME=$(echo "$tweet_json" | jq -r '.user.username // "unknown"')
                    DATE=$(echo "$tweet_json" | jq -r '.date // "N/A"')
                    LINK=$(echo "$tweet_json" | jq -r '.link // "#"')
                    TEXT=$(echo "$tweet_json" | jq -r '.text // ""' | sed 's/|/ÔΩú/g')

                    REPORT_TEXT="${REPORT_TEXT}<details>\n"
                    REPORT_TEXT="${REPORT_TEXT}<summary><b>${USERNAME}</b> ¬∑ ${DATE}</summary>\n\n"
                    REPORT_TEXT="${REPORT_TEXT}${TEXT}\n\n"
                    REPORT_TEXT="${REPORT_TEXT}üîó [ÏõêÎ≥∏ Î≥¥Í∏∞](${LINK})\n\n"
                    REPORT_TEXT="${REPORT_TEXT}</details>\n\n"
                  done < <(jq -c '.tweets[]' "$LATEST" 2>/dev/null)

                  REPORT_TEXT="${REPORT_TEXT}---\n\n"
                fi
              fi
            fi
          done

          echo "Ï¥ù ÏàòÏßë: ${TOTAL_TWEETS}Í±¥"

          # Issue ÏÉùÏÑ±
          if [ "$CREATE_ISSUE" == "true" ] && [ "$TOTAL_TWEETS" -ge "$THRESHOLD" ]; then
            BODY=$(cat <<EOF
          ## üö® X ÏúÑÌòë Ïù∏ÌÖîÎ¶¨Ï†ÑÏä§ Î¶¨Ìè¨Ìä∏

          | Ìï≠Î™© | Í∞í |
          |------|-----|
          | üìÖ ÏàòÏßë ÏãúÍ∞Ñ | $(date +'%Y-%m-%d %H:%M KST') |
          | üìä Ï¥ù Ìä∏Ïúó | **${TOTAL_TWEETS}Í±¥** |
          | üéØ Î™®ÎãàÌÑ∞ÎßÅ ÌÇ§ÏõåÎìú | ${TARGETS} |

          ---

          ## üìã ÌÇ§ÏõåÎìúÎ≥Ñ ÏöîÏïΩ

          | ÌÇ§ÏõåÎìú | ÏàòÏßëÎüâ |
          |--------|--------|
          $(printf "${TABLE_ROWS}")

          ---

          ## üìù ÏÉÅÏÑ∏ ÎÇ¥Ïö©

          $(printf "${REPORT_TEXT}")

          ---
          > ü§ñ _ÏûêÎèô ÏÉùÏÑ±Îêú Î¶¨Ìè¨Ìä∏ÏûÖÎãàÎã§._ | [Actions Î°úÍ∑∏](https://github.com/${{ github.repository }}/actions)
          EOF
          )

            gh issue create \
              --title "üö® [$(date +'%m/%d %H:%M')] ÏúÑÌòë Í∞êÏßÄ: ${TOTAL_TWEETS}Í±¥" \
              --body "$BODY" \
              --label "threat-intel,automated" || echo "Issue ÏÉùÏÑ± Ïã§Ìå®"
          fi

      - name: GPT Î∂ÑÏÑù Î∞è Mattermost ÏïåÎ¶º
        if: steps.commit.outputs.has_changes == 'true'
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MATTERMOST_WEBHOOK: ${{ secrets.MATTERMOST_WEBHOOK }}
          TARGETS: ${{ steps.config.outputs.TARGETS }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python analyze.py
